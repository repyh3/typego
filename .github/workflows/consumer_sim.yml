name: Consumer Simulation
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, "feat/*" ]

jobs:
  full-scale-test:
    name: "Scenario: Task Manager API"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      # 1. Install TypeGo CLI from the current branch
      - name: Install TypeGo
        run: go install -v ./cmd/typego

      # 2. Setup the "User Project"
      - name: Build Simulation Project
        run: |
          mkdir ~/task-manager
          cd ~/task-manager
          typego init task-manager
          
          # 1. Background Worker Script
          cat <<EOF > worker.ts
          import { Println } from "go:fmt";
          
          declare var self: any;
          declare function postMessage(msg: any): void;

          self.onmessage = (msg: any) => {
              Println("[Worker] Processing task: " + msg.data.id);
              // simulate work
              postMessage({ status: "done", id: msg.data.id });
          };
          EOF
          
          # 2. Main Server Script
          cat <<EOF > main.ts
          import { ListenAndServe, Request, Response } from "go:net/http";
          import { ReadFile, WriteFile } from "go:os";
          import { Println, Sprintf } from "go:fmt";
          import { Uuid, Sha256 } from "go:crypto";
          import { Worker } from "typego:worker";
          
          const worker = new Worker("./worker.ts");
          worker.onmessage = (msg) => Println("[Main] Worker finished: " + msg.data.id);
          
          // Middleware: Simple Auth
          const API_KEY_HASH = Sha256("secret-token");
          
          ListenAndServe(":3000", async (req: Request, res: Response) => {
             // Auth Check
             const token = req.headers["Authorization"];
             if (!token || Sha256(token as string) !== API_KEY_HASH) {
                 res.status(401).json({ error: "Unauthorized" });
                 return;
             }
             
             if (req.method === "POST" && req.path === "/tasks") {
                 const id = Uuid();
                 Println("Created Task: " + id);
                 res.json({ id: id, status: "pending" });
                 return;
             }
             
             // Trigger Worker
             if (req.method === "POST" && req.path.endsWith("/process")) {
                 const id = req.query["id"];
                 if (!id) {
                     res.status(400).json({ error: "missing id parameter" });
                     return;
                 }
                 worker.postMessage({ id: id });
                 res.json({ status: "processing_started" });
                 return;
             }
             
             res.status(404).json({ error: "Not Found" });
          });
          EOF

      # 3. Validation
      - name: Verify Runtime (Interpreter)
        run: |
          cd ~/task-manager
          # Start server in background
          typego run main.ts &
          PID=$!
          
          # Wait for server to start
          sleep 3
          
          echo "Test 1: Auth Failure"
          CODE=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:3000/tasks -X POST)
          if [ "$CODE" != "401" ]; then echo "Expected 401, got $CODE"; kill $PID; exit 1; fi
          
          echo "Test 2: Create Task (Success)"
          RESP=$(curl -H "Authorization: secret-token" -X POST http://localhost:3000/tasks -s)
          echo "Response: $RESP"
          if [[ "$RESP" != *"pending"* ]]; then echo "Expected pending status"; kill $PID; exit 1; fi
          
          # Retrieve ID (grep rough approach for simplicity)
          ID=$(echo $RESP | grep -oP '(?<="id":")[^"]*')
          
          echo "Test 3: Trigger Worker"
          curl -H "Authorization: secret-token" -X POST "http://localhost:3000/tasks/process?id=$ID"
          
          # Wait for worker log (captured in stdout? handled by CI logs)
          sleep 1
          
          kill $PID

      # 4. Prove it compiles
      - name: Verify Build (Binary)
        run: |
          cd ~/task-manager
          typego build -o task-server main.ts
          
          # Execute binary
          ./task-server &
          PID=$!
          
          sleep 3
          
          echo "Binary Test: Auth Success"
          CODE=$(curl -H "Authorization: secret-token" -o /dev/null -s -w "%{http_code}" -X POST http://localhost:3000/tasks)
          if [ "$CODE" != "200" ]; then echo "Expected 200, got $CODE"; kill $PID; exit 1; fi
          
          kill $PID
